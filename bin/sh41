#!/usr/bin/env sh

# NAME
#  sh41 -
#
# SYNOPSIS
#
# ENVIROMENT
#  SH41_BIN
#   Path to SH41 public bin directory.
#
#  SH41_LIB
#   Path to SH41 internal lib directory.
#
#  SH41_ICON
#   SH41 logo icon

# ╭───┤ Dependencies
# ╰─

if ! command -v "jq" >/dev/null 2>&1; then
  echo "sh41: jq is required to run this script" >&2
  exit 1
fi

# ╭───┤ Bootstrap
# ╰─

# Exit on first error
set -e

# Expose all internal utility scripts for the duration of the process
export PATH="$SH41_LIB/_scripts:$PATH"

# ╭───┤ Traps & Signals
# ╰─

# trace-process goes up the call stack until TP_ROOT_PID is reached
export TP_ROOT_PID="$PPID"
# trace-process removes TP_BASE_PATH when logging
export TP_BASE_PATH="$SH41_HOME"

debug() {
  exit_code=$?; 

  if [ $exit_code -ne 0 ]; then
    trace-process >&2
    exit $exit_code
  fi
}

trap debug EXIT

# ╭───┤ Main
# ╰─

subcommands_home="$SH41_BIN/subcommands"

case $1 in
  prompt)
    shift
    "$subcommands_home"/prompt "$@" < /dev/stdin
     ;;
  providers)
    shift
    "$subcommands_home"/providers "$@" < /dev/stdin
  ;;
  send)
    shift
    "$subcommands_home"/prompt validate < /dev/stdin \
      | if [ $? -eq 0 ]; then 
          "$subcommands_home"/send "$@"
        fi
    exit
  ;;
  *) 
    log -t error "unknown argument $1" "$SH41_ICON sh41"
    exit 1 
  ;;
esac
