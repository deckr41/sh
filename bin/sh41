#!/usr/bin/env sh

# NAME
#  sh41 -
#
# SYNOPSIS
#
# ENVIROMENT
#  SH41_BIN
#   The path to the bin home directory.
#
#  SH41_UTILS
#   The path to the utilities home directory.
#
#  SH41_ICON
#   SH41 logo icon

# Exit on first error
set -e

# When printing an error's stack trace, use this process' parent id as the stop
# point
export SH41_ROOT_PID="${SH41_ROOT_PID:-$PPID}"

# ╭───┤ Unexpected exit traps
# ╰─

debug_trace() {
  exit_code=$?; 

  if [ $exit_code -ne 0 ]; then
    "$SH41_UTILS"/trace-process >&2
    exit $exit_code
  fi
}

trap debug_trace EXIT

# ╭───┤ Global variables
# ╰─

CMD_NAME="sh41"

# ╭───┤ Functions
# ╰─

# Redirect stdin from /dev/tty to ensure it's treated as interactive and not
# inherited from parent's stdin
log_error() { "$SH41_UTILS"/log "$@" "$CMD_NAME" < /dev/tty; }

# ╭───┤ Main
# ╰─

case $1 in
  prompt)
    shift
    "$SH41_BIN"/sh41-prompt "$@" < /dev/stdin
  ;;
  providers)
    shift
    "$SH41_BIN"/sh41-provider "$@" < /dev/stdin
  ;;
  send)
    shift
    "$SH41_BIN"/sh41-prompt validate < /dev/stdin \
      | if [ $? -eq 0 ]; then 
          "$SH41_BIN"/sh41-send "$@"
        fi
    exit
  ;;
  *) log_error "unknown argument $1"; exit 1 ;;
esac
