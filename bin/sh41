#!/usr/bin/env sh

# NAME
#  sh41 - An agentic framework for solving problems together with Large Language Models.
#
# SYNOPSIS
#  sh41 conversations [...] 
#  sh41 providers [...]
#  sh41 send [...]
#
# ENVIROMENT
#  SH41_BIN
#   Path to SH41 public bin directory.
#
#  SH41_LIB
#   Path to SH41 internal lib directory.
#
#  SH41_ICON
#   SH41 logo icon
#
# ERRORS
#  1: Missing OS dependency
#  2: Invalid input - parsing error of stdin, argument or flag parsing

# ╭───┤ Bootstrap
# ╰─

# Exit on first error
set -e

# log config
export LOG_NAMESPACE="$SH41_ICON sh41"

# trap-debug config
export TD_ROOT_PID="$PPID"
export TD_BASE_PATH="$SH41_HOME"

# Expose all internal utility scripts for the duration of the process
export PATH="$SH41_LIB/_scripts:$PATH"

if ! command -v "jq" >/dev/null 2>&1; then
  log error "jq is required to run this script"
  exit 1
fi

# ╭───┤ Main
# ╰─

subcommands_home="$SH41_BIN/subcommands"
subcommand="$1"; shift

case $subcommand in
  conversations)
    "$subcommands_home"/conversations "$@" < /dev/stdin
   ;;
  providers)
    "$subcommands_home"/providers "$@" < /dev/stdin
  ;;
  send)
    stdin_input=$(cat)
    printf "%s" "$stdin_input" | "$subcommands_home"/conversations validate
    printf "%s" "$stdin_input" | "$subcommands_home"/send "$@"
  ;;
  *) 
    log error "Unknown argument $subcommand"
    exit 2
  ;;
esac
