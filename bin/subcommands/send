#!/usr/bin/env sh

# NAME
#  sh41-send - Send a message to an AI provider.
#
# SYNOPSIS
#  sh41-send -t|--to <value> [...provider specific arguments]
#
# STDIN
#  A JSON object containing the SH41 payload.
#
# OPTIONS
#  -t|--to <provider>
#   The provider to send the message to.
#
# ENVIROMENT
#  SH41_UTILS
#   Path to the SH41 internal utilities directory.

# ╭───┤ Bootstrap
# ╰─

# Exit on first error
set -e

# log config
export LOG_NAMESPACE="$SH41_ICON sh41-provider"

# ╭───┤ Functions
# ╰─

underline() { 
  stylize underline "$@"
}

# ╭───┤ Argument parsing
# ╰─

while [ "$#" -gt 0 ]; do
  case $1 in
    -t|--to)
      if [ "$2" ] && [ "${2#-}" = "$2" ]; then
        TO="$2"; shift
      else
        log error "-t|--to flag requires a value"
        exit 1
      fi
      shift
    ;;
    *) break ;;
  esac
done

# ╭───┤ Input validation 
# ╰─

if [ -z "$TO" ]; then
  log error "Missing required flag -t|--to. Must be first, before other provider specific arguments."
  exit 2
fi

providers_home="$SH41_LIB/providers"
provider_path="${providers_home}/${TO}"

if [ ! -f "$provider_path" ]; then
  log error "Provider $(underline "$TO") does not exist. To add a new provider, create a $(underline "$TO") shell file inside providers home: $providers_home"
  exit 3
fi

# ╭───┤ Main
# ╰─

log info "Sending prompt to $(underline "$TO") provider..."

"$provider_path" "$@" < /dev/stdin
