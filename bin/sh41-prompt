#!/usr/bin/env sh

# NAME
#  sh41-prompt - Index script for multiple prompt commands.
#
# SYNOPSIS
#  sh41-prompt build [...]
#  sh41-prompt append [...]
#  sh41-prompt validate [...]
#
# DESCRIPTION
#  Index script for multiple prompt commands: build, mutate and append.
#  The script passes along any stdin data and arguments to the underlying
#  command.
#
#  Prompt passing only via stdin is a design choice to enforce a consistent
#  interface across all commands and to avoid common "argument size limit
#  exceeded" errors, since prompts texts/message payloads can be quite large.

# Exit on first error
set -e

# When printing an error's stack trace, use this process' parent id as the stop
# point
export SH41_ROOT_PID="${SH41_ROOT_PID:-$PPID}"

# ╭───┤ Global variables
# ╰─

CMD_NAME="sh41-prompt"

# ╭───┤ Functions
# ╰─

# Redirect stdin from /dev/tty to ensure it's treated as interactive and not
# inherited from parent's stdin
log_error() { "$SH41_UTILS"/log "$@" "$CMD_NAME" < /dev/tty; }

# ╭───┤ Main 
# ╰─

case $1 in
  build)
    shift
    "$SH41_LIBS"/prompt/build "$@" < /dev/stdin
  ;;
  append)
    shift
    "$SH41_LIBS"/prompt/append "$@" < /dev/stdin
  ;;
  validate)
    shift
    "$SH41_LIBS"/prompt/validate "$@" < /dev/stdin
  ;;
  *) log_error "unknown argument $1"; exit 1 ;;
esac
